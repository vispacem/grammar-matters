
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>1 The split-apply-combine pattern &#8212;   documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5.5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="1-The-split-apply-combine-pattern">
<h1>1 The split-apply-combine pattern<a class="headerlink" href="#1-The-split-apply-combine-pattern" title="Permalink to this headline">¶</a></h1>
<p>In the exercise in Week 7, you downloaded data from Comtrade that could be described as ‘heterogenous’ or mixed in some way. For example, the same dataset contained information relating to both imports and exports.</p>
<p>To find the partner countries with the largest trade value in terms of exports means filtering the dataset to obtain just the rows containing export data and then ranking those. Finding the largest import partner requires a sort on just the import data.</p>
<p><img alt="A close-up image of someone putting glue onto a plank of wood" src="../../_images/ou_futurelearn_learn_to_code_fig_1062.jpg" /></p>
<p><strong>Figure 1</strong></p>
<p>But what if you wanted to find out even more refined information? For example:</p>
<ul class="simple">
<li><p>the total value of exports of product X from the UK to those countries on a year by year basis (group the information by year and then find the total for each year)</p></li>
<li><p>the total value of exports of product X from the UK to each of the partner countries by year (group the information by country and year and then find the total for each country/year pairing)</p></li>
<li><p>the average value of exports across all the countries on a month by month basis (group by month, then find the average value per month)</p></li>
<li><p>the average value of exports across each country on a month by month basis (group by month and country, then find the average value over each country/month pairing)</p></li>
<li><p>the difference month on month between the value of imports from, or exports to, each particular country over the five year period (group by country, order by month and year, then find the difference between consecutive months).</p></li>
</ul>
<p>In each case, the original dataset needs to be separated into several subsets, or groups of data rows, and then some operation performed on those rows. To generate a single, final report would then require combining the results of those operations in a new or extended dataframe.</p>
<p>This sequence of operations is common enough for it to have been described as the ‘split-apply-combine’ pattern. The sequence is to:</p>
<ul class="simple">
<li><p>‘split’ an appropriately shaped dataset into several components</p></li>
<li><p>‘apply’ an operator to the rows contained within a component</p></li>
<li><p>‘combine’ the results of applying to operator to each component to return a single combined result.</p></li>
</ul>
<p>You will see how to make use of this pattern using pandas next.</p>
<div class="section" id="1.1-Splitting-a-dataset-by-grouping">
<h2>1.1 Splitting a dataset by grouping<a class="headerlink" href="#1.1-Splitting-a-dataset-by-grouping" title="Permalink to this headline">¶</a></h2>
<p>‘Grouping’ refers to the process of splitting a dataset into sets of rows, or ‘groups’, on the basis of one or more criteria associated with each data row.</p>
<p>Grouping is often used to split a dataset into one or more distinct groups. Each row in the dataset being grouped around can be assigned to one, and only one, of the derived groups. The rows associated with a particular group may be accessed by reference to the group or the same processing or reporting operation may be applied to the rows contained in each group on a group by group basis.</p>
<p><img alt="The first table on the left contains commodity and amount columns, there are amounts grouped by commodity A, B and C. Data is: A 10; A 15; A 5; A 20; B 10; B 10; B 5; C 20; C 30. There are arrows to three further tables which splits out the commodities into separate tables for each commodity. Data is from a dataset." src="../../_images/ou_futurelearn_learn_to_code_fig_1016.jpg" /></p>
<p><strong>Figure 2</strong></p>
<p>The rows do not have to be ‘grouped’ together in the original dataset – they could appear in any order in the original dataset (for example, a commodity A row, followed by a two commodity B rows, then another commodity A row, and so on). However, the order in which each row appears in the original dataset will typically be reflected by the order in which the rows appear in each subgroup.</p>
<p>Let’s see how to do that in pandas. Create a simple dataframe that looks like the full table in the image above:</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>data=[[&#39;A&#39;,10],[&#39;A&#39;,15],[&#39;A&#39;,5],[&#39;A&#39;,20],
              [&#39;B&#39;,10],[&#39;B&#39;,10],[&#39;B&#39;,5],
              [&#39;C&#39;,20],[&#39;C&#39;,30]]
df=DataFrame(data=data, columns=[&quot;Commodity&quot;,&quot;Amount&quot;])
df
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>0</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>1</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>15</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>2</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>3</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>4</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>5</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>6</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>7</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>8</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr></tbody></table><p>Next, use the <code class="docutils literal notranslate"><span class="pre">groupby()</span></code> method to group the dataframe into separate groups of rows based on the values contained within one or more specified ‘key’ columns. For example, group the rows according to what sort of commodity each row corresponds to as specified by the value taken in the ‘Commodity’ column.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">grouped</span> <span class="pre">=</span> <span class="pre">df.groupby('Commodity')</span></code></p>
<p>The number and ‘names’ of the groups that are identified correspond to the unique values that can be found within the column or columns (which will be referred to as the ‘key columns’) used to identify the groups.</p>
<p>You can see what groups are available with the following method call:</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">grouped.groups.keys()</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">['A',</span> <span class="pre">'C',</span> <span class="pre">'B']</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">get_group()</span></code> method can be used to grab just the rows associated with a particular group.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">grouped.get_group('B')</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>4</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>5</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>6</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr></tbody></table><p>Datasets can also be grouped against multiple columns. For example, if there was an extra ‘Year’ column in the above table, you could group against just the commodity, exactly as above, to provide access to rows by commodity; just the year, setting <code class="docutils literal notranslate"><span class="pre">grouped</span> <span class="pre">=</span> <span class="pre">df.groupby(</span> <span class="pre">'Year'</span> <span class="pre">);</span></code> or by both commodity and year, passing in the two grouping key columns as a list:</p>
<p><code class="docutils literal notranslate"><span class="pre">grouped</span> <span class="pre">=</span> <span class="pre">df.groupby(</span> <span class="pre">['Commodity','Year'])</span></code></p>
<p>The list of keys associated with the groups might then look like [(‘A’, 2015), (‘A’, 2014), (‘B’, 2015), (‘B’, 2014)]. The rows associated with the group corresponding to commodity A in 2014 could then be retrieved using the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">grouped.get_group(</span> <span class="pre">('A',2014)</span> <span class="pre">)</span></code></p>
<p>This may seem to you like a roundabout way of filtering the dataframe as you did in Week 2; but you’ll see that the ability to automatically group rows sets up the possibility of then processing those rows as separate ‘mini-dataframes’ and then combining the results back together.</p>
<div class="section" id="Exercise-2-Grouping-data">
<h3>Exercise 2 Grouping data<a class="headerlink" href="#Exercise-2-Grouping-data" title="Permalink to this headline">¶</a></h3>
<div class="section" id="Question">
<h4>Question<a class="headerlink" href="#Question" title="Permalink to this headline">¶</a></h4>
<p>Work through Exercise 2 in the Week 4 notebook.</p>
<p>As you complete the tasks, think about these questions:</p>
<ul class="simple">
<li><p>For your particular dataset, how did you group the data and what questions did you ask of it? Which countries were the major partners of your reporter country for the different groupings?</p></li>
<li><p>With the ability to group data so easily, what other sorts of questions would you like to be able to ask?</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="1.2-Looking-at-apply-and-combine-operations">
<h2>1.2 Looking at apply and combine operations<a class="headerlink" href="#1.2-Looking-at-apply-and-combine-operations" title="Permalink to this headline">¶</a></h2>
<p>Having split a dataset by grouping, an operation is ‘applied’ to each group.</p>
<p><img alt="A close-up image of a cubes of wood interlaced, making a pattern" src="../../_images/ou_futurelearn_learn_to_code_fig_1063.jpg" /></p>
<p><strong>Figure 3</strong></p>
<p>The operation often takes one of two forms:</p>
<ul class="simple">
<li><p>a ‘summary’ operation, in which a summary statistic based on the rows contained within each group is generated. A single value is returned for each group, for example, the group median or mean, the number of rows in the group, or the maximum or minimum value in the group. The final result will have <em>M</em> rows, one for each of the M groups created by the split (that is, . <code class="docutils literal notranslate"><span class="pre">groupby()</span></code> ) operation.</p></li>
<li><p>a ‘filtering’ or ‘filtration’ operation, in which groups of rows are retained or discarded based on a particular property of the group as a whole. For example, only groups of rows where the sum of all the values in the group is above some threshold are retained. The effect is that each group keeps the same number of rows, but the resulting dataset (after combination, see below) may contain fewer groups than the original.</p></li>
</ul>
<p>The results of applying the summary or filtration operation are then combined to provide a single output dataframe.</p>
<p>In the next section, you will see how to apply a variety of summary operations, and in a later step examples of filtration operations.</p>
</div>
<div class="section" id="1.3-Summary-operations">
<h2>1.3 Summary operations<a class="headerlink" href="#1.3-Summary-operations" title="Permalink to this headline">¶</a></h2>
<p>Summary, or aggregation, operations are used to produce a single summary value or statistic, such as the group average, for each separate group.</p>
<p>Find the ‘total’ amount within each group using a <strong>summary</strong> operation:</p>
<p><img alt="applying a summary operator to the rows contained within each group for each group separately: Three tables one for each Commodity A, B and C with their amounts. Amount for each commodity are then totalled" src="../../_images/ou_futurelearn_learn_to_code_fig_1014.jpg" /></p>
<p><strong>Figure 4</strong></p>
<p>To apply a summary operator to each group, such as a function to find the mean value of each group, and then automatically combine the results into a single output dataframe, pass the name of the function in to the <code class="docutils literal notranslate"><span class="pre">aggregate()</span></code> method. Note that pandas will try to use this operator to summarise each column in the grouped rows separately if there is more than one column that can be summarised. So for example, if there was a ‘Volume’ column, it would also return total volumes.</p>
<p>Let’s use again the example dataframe defined earlier:</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">df</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p>0</p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>1</p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>15</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>2</p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>3</p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>4</p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>5</p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>6</p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>7</p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p>8</p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr></tbody></table><p>Group the data by commodity type and then apply the <code class="docutils literal notranslate"><span class="pre">sum</span></code> operation and combine the results in an output dataframe. The grouping elements are used to create index values in the output dataframe.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>grouped=df.groupby(&#39;Commodity&#39;)
grouped.aggregate(sum)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Amount</p>
</th></tr><tr><th><p>Commodity</p>
</th><td class="highlight_" rowspan colspan></td></tr><tr><td class="highlight_" rowspan colspan><p><strong>A</strong></p>
</td><td class="highlight_" rowspan colspan><p>50</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>B</strong></p>
</td><td class="highlight_" rowspan colspan><p>25</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>C</strong></p>
</td><td class="highlight_" rowspan colspan><p>50</p>
</td></tr></tbody></table><p>In this case, the <code class="docutils literal notranslate"><span class="pre">aggregate()</span></code> method applies the sum summary operation to each group and then automatically combines the results. For a <strong>summary</strong> operation such as this, the resulting combined dataframe contains as many rows as there were groups created by the splitting <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> operation.</p>
<p><img alt="the individual summaries, the results of the previous image, for each group Commodities A, B and C are combined into a single dataframe" src="../../_images/ou_futurelearn_learn_to_code_fig_1015.jpg" /></p>
<p><strong>Figure 5</strong></p>
<p>The slightly more general <code class="docutils literal notranslate"><span class="pre">apply()</span></code> method can also be substituted for the <code class="docutils literal notranslate"><span class="pre">aggregate()</span></code> method and will similarly take the rows associated with each group, apply a function to them, and return a combined result.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">apply()</span></code> method can be really handy if you have defined a function of your own that you want to apply to just the rows associated with each group. Simply pass the name of the function to the <code class="docutils literal notranslate"><span class="pre">apply()</span></code> method and it will then call your function, once per group, on the sets of rows associated with each group.</p>
<p>For example, find the top two items by ‘Amount’ in each group:</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>def top2byAmount(g):
        return g.sort_values(&#39;Amount&#39;, ascending=False).head(2)
grouped.apply(top2byAmount)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th></th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>Commodity</strong></p>
</td><td class="highlight_" rowspan colspan></td><td class="highlight_" rowspan colspan></td></tr><tr><td class="highlight_" rowspan colspan><p><strong>A</strong></p>
</td><td class="highlight_" rowspan colspan><p>3</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan></td><td class="highlight_" rowspan colspan><p>1</p>
</td><td class="highlight_" rowspan colspan><p>15</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>B</strong></p>
</td><td class="highlight_" rowspan colspan><p>4</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan></td><td class="highlight_" rowspan colspan><p>5</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>C</strong></p>
</td><td class="highlight_" rowspan colspan><p>8</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr><tr><td class="highlight_" rowspan colspan></td><td class="highlight_" rowspan colspan><p>7</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr></tbody></table><p>The second index column containing the numbers 3, 1, 4 etc., contains the original index value of each row.</p>
<p>In Week 3 the <code class="docutils literal notranslate"><span class="pre">apply()</span></code> method was called on a column, to apply the given function to each cell. Here it was called on a grouped dataframe, to apply the given function to each group.</p>
<div class="section" id="Exercise-3-Experimenting-with-split-apply-combine">
<h3>Exercise 3 Experimenting with split-apply-combine<a class="headerlink" href="#Exercise-3-Experimenting-with-split-apply-combine" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Question<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Work through Exercise 3 in your Exercise notebook 4 to practise the summary operations.</p>
<p>As you complete the tasks, think about these questions:</p>
<ul class="simple">
<li><p>For your dataset, which months saw the highest and lowest levels of trade activity? Did there appear to be any seasonal behaviour?</p></li>
<li><p>When graphically comparing total trade flows from the leading partner countries to the World total, did it look as if any partners particularly dominated that area of trade? If you have time, find news reports discussing why this should be the case.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="1.4-Filtering-groups">
<h2>1.4 Filtering groups<a class="headerlink" href="#1.4-Filtering-groups" title="Permalink to this headline">¶</a></h2>
<p>Being able to group rows according to some criterion and then apply various operations to those groups is a very powerful technique.</p>
<p>However, there may be occasions when you only want to work with a subset of the groups that can be extracted from a single dataset based on a particular group property. For example, it might require that:</p>
<ul class="simple">
<li><p>groups that contain a minimum number of rows, such as countries that engage in trade around a particular commodity with a minimum number of partner countries</p></li>
<li><p>groups for whom a summary statistic meets certain conditions (for example, the total value of exports for a particular commodity exceeds a particular threshold value, or whose minimum or maximum value are below a certain value)</p></li>
<li><p>a ranking of the groups based on a particular summary statistic, such as the total trade value, that returns only the top five or bottom three groups according to that ranking.</p></li>
</ul>
<p>In the following example, where groups are selected based on group size, a filtering operation is applied to limit an original dataset so that it includes just those groups containing at least three rows, combining the rows from the selected groups back together again to produce the output dataset:</p>
<p><img alt="dataframe for each commodity A, B and C and their amounts. Filter operation applied to select rows associated with groups that pass a filtration test applied to each group and combined into one dataframe." src="../../_images/ou_futurelearn_learn_to_code_fig_1017.jpg" /></p>
<p><strong>Figure 6</strong></p>
<p>In pandas, groups can be filtered based on their group properties using the <code class="docutils literal notranslate"><span class="pre">filter()</span></code> method. Using the example dataframe again:</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">df</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>0</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>1</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>15</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>2</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>3</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>4</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>5</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>6</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>7</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>8</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr></tbody></table><p>For example, the dataframe can be filtered to return just the rows from groups where there is a maximum number of rows in the group.</p>
<p>As a reference point, count how many rows are associated with each group.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>grouped = df.groupby(&#39;Commodity&#39;)
grouped.aggregate(len)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>Commodity</strong></p>
</td><td class="highlight_" rowspan colspan></td></tr><tr><td class="highlight_" rowspan colspan><p><strong>A</strong></p>
</td><td class="highlight_" rowspan colspan><p>4</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>B</strong></p>
</td><td class="highlight_" rowspan colspan><p>3</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>C</strong></p>
</td><td class="highlight_" rowspan colspan><p>2</p>
</td></tr></tbody></table><p>The <code class="docutils literal notranslate"><span class="pre">filter()</span></code> method uses a function that returns a boolean ( <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> ) value to decide whether or not to filter through the rows associated with a particular group.</p>
<p>As with the <code class="docutils literal notranslate"><span class="pre">apply()</span></code> method, provide the <code class="docutils literal notranslate"><span class="pre">filter()</span></code> method with just a function name in order to pass each group to that function. For example, define a function that says whether or not a group contains three or fewer rows and use that as a basis for filtering the original dataset.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>def groupsOfAtMostThreeRows(g):
        return len(g) &lt;= 3
grouped.filter(groupsOfAtMostThreeRows)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>4</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>5</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>6</strong></p>
</td><td class="highlight_" rowspan colspan><p>B</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>7</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>8</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr></tbody></table><p>Alternatively, all the rows in a group can be filtered on an aggregate property of the group such as the sum total, or maximum, minimum or mean value, from one of the columns.</p>
<p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>#Consider the following total amounts by group
grouped.aggregate(sum)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>Commodity</strong></p>
</td><td class="highlight_" rowspan colspan></td></tr><tr><td class="highlight_" rowspan colspan><p><strong>A</strong></p>
</td><td class="highlight_" rowspan colspan><p>50</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>B</strong></p>
</td><td class="highlight_" rowspan colspan><p>25</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>C</strong></p>
</td><td class="highlight_" rowspan colspan><p>50</p>
</td></tr></tbody></table><p><code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[]:</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>

<span></span>pivot_table(df,
               index=[&#39;Commodity&#39;,&#39;Partner&#39;],
               values=&#39;Amount&#39;,
               aggfunc=sum)
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Out[]:</span></code></p>
<table xmlns:str="http://exslt.org/strings"><caption></caption><tbody><tr><th></th><th><p>Commodity</p>
</th><th><p>Amount</p>
</th></tr><tr><td class="highlight_" rowspan colspan><p><strong>0</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>10</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>1</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>15</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>2</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>5</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>3</strong></p>
</td><td class="highlight_" rowspan colspan><p>A</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>7</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>20</p>
</td></tr><tr><td class="highlight_" rowspan colspan><p><strong>8</strong></p>
</td><td class="highlight_" rowspan colspan><p>C</p>
</td><td class="highlight_" rowspan colspan><p>30</p>
</td></tr></tbody></table><p>The ability to filter datasets based on group properties means that large datasets can more easily be limited to just those rows associated with groups of rows that are deemed to be relevant in some way.</p>
<div class="section" id="Exercise-4-Filtering-groups">
<h3>Exercise 4 Filtering groups<a class="headerlink" href="#Exercise-4-Filtering-groups" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id2">
<h4>Question<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Use the Exercise notebook 4 to practise filtering in Exercise 4.</p>
<p>As you complete the tasks, think about other questions you could ask of your data using the filter command.</p>
</div>
</div>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html"></a></h1>



<p class="blurb">Documentation...</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../session_01/Part_01_01.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_01/Part_01_02.html">1 Install the software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_01/Part_01_03.html">2 This week’s quiz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_01/Part_01_04.html">3 Summary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../session_02/Part_02_01.html">1 Enter the pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_02/Part_02_02.html">2 Writing up the analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_02/Part_02_03.html">3 This week’s quiz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session_02/Part_02_04.html">4 Summary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/content/session_08/Part_08_01.md"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>